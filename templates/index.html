<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyone DocAgent - Documenta√ß√£o Autom√°tica com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        skyone: '#1a365d',
                        skyoneLight: '#2d5a87',
                        skyoneAccent: '#4a90e2'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-skyone">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-skyone to-skyoneLight rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-skyone">Skyone DocAgent</h1>
                        <p class="text-sm text-skyoneLight font-medium">Documenta√ß√£o Autom√°tica ‚Ä¢ C4 + An√°lise Detalhada</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="systemStatus" class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-sm font-medium">
                        <i class="fas fa-circle animate-pulse mr-1"></i>
                        Sistema
                    </span>
                    <span class="px-3 py-1 bg-skyone text-white rounded-full text-sm font-medium">
                        v3.0
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        
        <!-- Skyone Hero Section -->
        <div class="text-center mb-8">
            <div class="bg-gradient-to-r from-skyone to-skyoneLight rounded-2xl p-8 text-white shadow-xl">
                <h2 class="text-4xl font-bold mb-4">
                    <i class="fas fa-sitemap mr-3"></i>
                    Skyone DocAgent
                </h2>
                <p class="text-xl text-blue-100 max-w-3xl mx-auto">
                    Agente inteligente da Skyone para documenta√ß√£o autom√°tica com arquitetura C4 + An√°lise Detalhada.
                    An√°lise completa de projetos locais com IA avan√ßada gerando 8 tipos de documenta√ß√£o.
                </p>
            </div>
        </div>

        <!-- Model Selection Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-brain text-skyoneAccent text-xl mr-3"></i>
                <h3 class="text-xl font-bold text-skyone">Modelo de IA</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <!-- OpenAI -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-skyone mb-3">OpenAI GPT</h4>
                    <select id="openaiModel" class="w-full px-3 py-2 border rounded-lg mb-3">
                        <option value="gpt-4o">GPT-4o (Recomendado)</option>
                        <option value="gpt-4o-mini">GPT-4o Mini (R√°pido)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16K</option>
                        <option value="text-davinci-003">Text Davinci 003</option>
                        <option value="text-davinci-002">Text Davinci 002</option>
                    </select>
                    <input type="password" id="openaiApiKey" placeholder="API Key..." 
                           class="w-full px-3 py-2 border rounded-lg mb-3">
                    <button onclick="selecionarOpenAI()" 
                            class="w-full bg-skyoneAccent text-white py-2 rounded-lg hover:bg-skyoneLight transition-all">
                        Usar OpenAI
                    </button>
                </div>

                <!-- Ollama -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-skyone mb-3">Ollama Local</h4>
                    <select id="ollamaModel" class="w-full px-3 py-2 border rounded-lg mb-3">
                        <option value="qwen2.5:7b">Qwen2.5 7B</option>
                        <option value="llama3.2:3b">Llama 3.2 3B</option>
                        <option value="codellama:7b">CodeLlama 7B</option>
                    </select>
                    <input type="text" id="ollamaBaseUrl" value="http://localhost:11434" 
                           class="w-full px-3 py-2 border rounded-lg mb-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="verificarOllama()" 
                                class="bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-all text-sm">
                            <i class="fas fa-sync mr-1"></i>
                            Atualizar Lista
                        </button>
                        <button onclick="selecionarOllama()" 
                                class="bg-skyone text-white py-2 rounded-lg hover:bg-skyoneLight transition-all text-sm">
                            <i class="fas fa-check mr-1"></i>
                            Usar Ollama
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Current Model -->
            <div class="bg-gray-50 rounded-lg p-3 flex items-center justify-between">
                <span class="text-sm text-gray-700">Modelo: <span id="currentModelText" class="font-semibold">Nenhum</span></span>
                <span id="modelStatus" class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-sm">
                    <i class="fas fa-circle mr-1"></i>Aguardando
                </span>
            </div>
        </div>

        <!-- Directory Selection Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-folder text-skyoneAccent text-xl mr-3"></i>
                <h3 class="text-xl font-bold text-skyone">Diret√≥rio do Projeto</h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div class="lg:col-span-3">
                    <label for="projectPath" class="block text-sm font-medium text-gray-700 mb-2">
                        Caminho do Projeto Local
                    </label>
                    <input type="text" id="projectPath" placeholder="/caminho/para/seu/projeto" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-skyoneAccent">
                    <p class="text-xs text-gray-500 mt-1">Informe o caminho completo do diret√≥rio do projeto</p>
                </div>
                <div class="flex flex-col justify-end">
                    <label class="flex items-center mb-3">
                        <input type="checkbox" id="modoAnonimo" class="mr-2 h-4 w-4 text-skyoneAccent" checked>
                        <span class="text-sm text-gray-700">Relat√≥rio An√¥nimo</span>
                    </label>
                    <button onclick="analisarDiretorio()" id="btnAnalisar"
                            class="bg-gradient-to-r from-skyone to-skyoneLight text-white px-6 py-3 rounded-lg hover:from-skyoneLight hover:to-skyoneAccent transition-all font-medium">
                        <i class="fas fa-play mr-2"></i>
                        An√°lise Completa (C4 + Detalhada)
                    </button>
                </div>
            </div>
        </div>



        <!-- Analysis Section -->
        <div id="analysisSection" class="hidden">
            <!-- Skyone Analysis Section -->
            <div class="bg-gradient-to-r from-skyone to-skyoneLight rounded-2xl shadow-2xl p-8 mb-8 text-white">
                <h3 class="text-3xl font-bold mb-6 flex items-center">
                    <i class="fas fa-sitemap mr-4 text-4xl animate-pulse"></i>
                    <div>
                        <div>Skyone DocAgent</div>
                        <div class="text-lg font-normal text-blue-200">C4 + An√°lise Detalhada ‚Ä¢ 8 Documentos</div>
                    </div>
                </h3>
                
                <!-- C4 + An√°lise Detalhada Progress Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <!-- C4 Architecture -->
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-blue-200 text-xs font-medium">C4 Context</div>
                        <div id="contextStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-blue-200 text-xs font-medium">C4 Container</div>
                        <div id="containerStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-blue-200 text-xs font-medium">C4 Component</div>
                        <div id="componentStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-blue-200 text-xs font-medium">C4 Code</div>
                        <div id="codeStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    
                    <!-- An√°lise Detalhada -->
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-green-200 text-xs font-medium">Detailed Analysis</div>
                        <div id="detailedStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-green-200 text-xs font-medium">Structure Report</div>
                        <div id="structureStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-green-200 text-xs font-medium">Implementation</div>
                        <div id="implementationStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur">
                        <div class="text-green-200 text-xs font-medium">Flowcharts</div>
                        <div id="flowchartsStatus" class="text-sm font-bold">Aguardando</div>
                    </div>
                </div>
                
                <!-- Main Status -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Fase Atual</div>
                        <div id="phaseText" class="text-xl font-bold">Iniciando...</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Progresso</div>
                        <div id="progressText" class="text-xl font-bold">0%</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="w-full bg-white bg-opacity-20 rounded-full h-4">
                        <div id="progressBar" class="bg-gradient-to-r from-skyoneAccent to-blue-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status Message -->
                <div id="statusMessage" class="text-lg text-blue-100 mb-4 p-3 bg-white bg-opacity-10 rounded-lg"></div>
                
                <!-- Logs Display -->
                <div class="bg-black bg-opacity-40 rounded-lg p-4 border border-white border-opacity-20">
                    <h4 class="font-bold text-lg mb-3 flex items-center">
                        <i class="fas fa-terminal mr-2 text-skyoneAccent"></i>
                        Logs do Skyone Agent
                        <span class="ml-auto text-sm text-gray-300">Tempo Real</span>
                    </h4>
                    <div id="logsContainer" class="max-h-64 overflow-y-auto">
                        <div id="logs" class="text-sm font-mono text-green-300 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="analysisResults" class="hidden bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-file-alt text-green-600 mr-3"></i>
                    Documenta√ß√£o LangGraph Conclu√≠da
                </h3>
                <div id="resultsContent">
                    <!-- Resultados ser√£o inseridos aqui -->
                </div>
            </div>
        </div>



    </main>

    <!-- Footer -->
    <footer class="bg-skyone text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 <strong>Skyone DocAgent</strong> v3.0 - C4 + An√°lise Detalhada ‚Ä¢ 8 Documentos</p>
            <p class="text-blue-200 mt-2">Produto Skyone ‚Ä¢ IA Avan√ßada ‚Ä¢ An√°lise T√©cnica Profunda</p>
        </div>
    </footer>

    <script>
        let repositorios = [];
        let analysisInterval = null;
        let currentModel = { provider: null, model: null };
        let langGraphAvailable = false;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ü§ñ Skyone DocAgent v3.0 carregado!');
            checkSystemStatus();
            carregarModeloSalvo();
            carregarModelosOllama();
            
            // Event listener para Enter no campo de diret√≥rio
            document.getElementById('projectPath').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    analisarDiretorio();
                }
            });
        });

        // Model Management
        async function selecionarOpenAI() {
            const model = document.getElementById('openaiModel').value;
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            
            if (!apiKey) {
                alert('Por favor, insira sua API Key do OpenAI');
                return;
            }
            
            // Testar e configurar OpenAI
            await testarEConfigurarModelo('openai', model, apiKey);
        }

        async function selecionarOllama() {
            const model = document.getElementById('ollamaModel').value;
            const baseUrl = document.getElementById('ollamaBaseUrl').value.trim();
            
            // Testar e configurar Ollama
            await testarEConfigurarModelo('ollama', model, null, baseUrl);
        }

        async function testarEConfigurarModelo(provider, model, apiKey = null, baseUrl = null) {
            try {
                // Mostrar status de teste
                const statusEl = document.getElementById('modelStatus');
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testando...';
                statusEl.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm';
                
                // Testar modelo primeiro
                const testResponse = await fetch('/api/test-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        model_name: model,
                        api_key: apiKey,
                        base_url: baseUrl
                    })
                });
                
                const testData = await testResponse.json();
                
                if (testData.success) {
                    // Teste bem-sucedido, configurar modelo
                    const configResponse = await fetch('/api/configure-model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            provider: provider,
                            model_name: model,
                            api_key: apiKey,
                            base_url: baseUrl
                        })
                    });
                    
                    const configData = await configResponse.json();
                    
                    if (configData.success) {
                        // Sucesso total
                        currentModel = { provider, model, apiKey, baseUrl };
                        
                        // Atualizar UI com verifica√ß√µes de seguran√ßa
                        const currentModelTextEl = document.getElementById('currentModelText');
                        const currentModelDisplayEl = document.getElementById('currentModelDisplay');
                        
                        if (currentModelTextEl) {
                            currentModelTextEl.textContent = `${provider.toUpperCase()} - ${model}`;
                        }
                        if (currentModelDisplayEl) {
                            currentModelDisplayEl.textContent = `${provider}/${model}`;
                        }
                        
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Ativo';
                            statusEl.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                        }
                        
                        // Armazenar configura√ß√£o
                        sessionStorage.setItem('current_model', JSON.stringify(currentModel));
                        
                        alert(`‚úÖ Modelo ${provider.toUpperCase()}/${model} configurado com sucesso!`);
                        console.log(`‚úÖ Modelo configurado: ${provider}/${model}`);
                    } else {
                        throw new Error(configData.message || 'Falha na configura√ß√£o');
                    }
                } else {
                    throw new Error(testData.error || 'Falha no teste do modelo');
                }
                
            } catch (error) {
                console.error('Erro ao configurar modelo:', error);
                
                const statusEl = document.getElementById('modelStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Erro';
                    statusEl.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm';
                }
                
                alert(`‚ùå Erro ao configurar modelo: ${error.message}`);
            }
        }

        async function verificarOllama() {
            try {
                const baseUrl = document.getElementById('ollamaBaseUrl').value.trim();
                
                console.log(`üîç Verificando Ollama em: ${baseUrl}`);
                
                // Tentar conectar com Ollama usando endpoint correto
                const response = await fetch(`${baseUrl}/api/tags`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const modelCount = data.models?.length || 0;
                    
                    alert(`‚úÖ Ollama conectado!\nModelos dispon√≠veis: ${modelCount}\nURL: ${baseUrl}`);
                    console.log(`‚úÖ Ollama OK: ${modelCount} modelos encontrados`);
                    
                    // Atualizar lista de modelos com dados do Ollama
                    if (data.models && data.models.length > 0) {
                        atualizarModelosOllamaLocal(data.models);
                    } else {
                        alert('‚ö†Ô∏è Nenhum modelo encontrado no Ollama. Execute: ollama pull modelo_desejado');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Erro Ollama response:', response.status, errorText);
                    alert(`‚ùå Ollama n√£o est√° respondendo (${response.status})\nVerifique se est√° rodando: ollama serve`);
                }
            } catch (error) {
                console.error('Erro ao conectar com Ollama:', error);
                alert(`‚ùå Erro ao conectar com Ollama:\n${error.message}\n\nVerifique:\n1. Ollama est√° rodando (ollama serve)\n2. URL est√° correta\n3. N√£o h√° bloqueio de CORS`);
            }
        }

        async function atualizarModelosOllamaLocal(models) {
            const select = document.getElementById('ollamaModel');
            select.innerHTML = '';
            
            if (models.length === 0) {
                select.innerHTML = '<option value="">Nenhum modelo encontrado</option>';
                return;
            }
            
            console.log(`üìã Atualizando lista com ${models.length} modelos Ollama`);
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.size || 'Tamanho desconhecido'})`;
                select.appendChild(option);
            });
            
            // Selecionar o primeiro modelo por padr√£o
            if (models.length > 0) {
                select.value = models[0].name;
                console.log(`‚úÖ Modelo padr√£o selecionado: ${models[0].name}`);
            }
        }

        async function carregarModelosOllama() {
            try {
                console.log('üîÑ Carregando modelos Ollama do backend...');
                
                const response = await fetch('/api/models/available');
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos do backend:', data);
                
                if (data.success) {
                    // Tentar usar ollama_detailed primeiro
                    if (data.ollama_detailed && data.ollama_detailed.length > 0) {
                        atualizarModelosOllama(data.ollama_detailed);
                        console.log(`‚úÖ ${data.ollama_detailed.length} modelos Ollama carregados (detalhados)`);
                        return;
                    }
                    
                    // Fallback: usar lista simples do backend
                    if (data.models && data.models.ollama && data.models.ollama.length > 0) {
                        const modelsSimple = data.models.ollama.map(name => ({
                            name: name,
                            size: "Tamanho desconhecido",
                            display_name: name
                        }));
                        atualizarModelosOllama(modelsSimple);
                        console.log(`‚úÖ ${modelsSimple.length} modelos Ollama carregados (simples)`);
                        return;
                    }
                }
                
                // √öltimo fallback: conex√£o direta com Ollama
                console.warn('‚ö†Ô∏è Backend n√£o retornou modelos, tentando conex√£o direta...');
                await conectarDiretamenteOllama();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar modelos do backend:', error);
                // Tentar conex√£o direta como √∫ltimo recurso
                await conectarDiretamenteOllama();
            }
        }

        async function conectarDiretamenteOllama() {
            try {
                const ollamaUrl = document.getElementById('ollamaBaseUrl')?.value?.trim() || 'http://localhost:11434';
                console.log(`üîó Tentando conex√£o direta com Ollama: ${ollamaUrl}`);
                
                const directResponse = await fetch(`${ollamaUrl}/api/tags`);
                
                if (directResponse.ok) {
                    const directData = await directResponse.json();
                    if (directData.models && directData.models.length > 0) {
                        atualizarModelosOllamaLocal(directData.models);
                        console.log(`‚úÖ ${directData.models.length} modelos carregados diretamente do Ollama`);
                    } else {
                        console.warn('‚ö†Ô∏è Ollama conectado mas sem modelos');
                        mostrarErroSemModelos();
                    }
                } else {
                    console.error(`‚ùå Ollama n√£o respondeu: ${directResponse.status}`);
                    mostrarErroConexaoOllama();
                }
            } catch (directError) {
                console.error('‚ùå Conex√£o direta com Ollama falhou:', directError);
                mostrarErroConexaoOllama();
            }
        }

        function mostrarErroSemModelos() {
            const select = document.getElementById('ollamaModel');
            if (select) {
                select.innerHTML = '<option value="">Nenhum modelo encontrado - Execute: ollama pull qwen2.5:7b</option>';
            }
        }

        function mostrarErroConexaoOllama() {
            const select = document.getElementById('ollamaModel');
            if (select) {
                select.innerHTML = '<option value="">Erro de conex√£o - Execute: ollama serve</option>';
            }
        }

        function atualizarModelosOllama(models) {
            const select = document.getElementById('ollamaModel');
            if (!select) {
                console.error('‚ùå Elemento ollamaModel n√£o encontrado');
                return;
            }
            
            select.innerHTML = '';
            
            if (!models || models.length === 0) {
                select.innerHTML = '<option value="">Nenhum modelo encontrado</option>';
                return;
            }
            
            console.log(`üìã Atualizando select com ${models.length} modelos`);
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name || model;
                option.textContent = model.display_name || model.name || model;
                select.appendChild(option);
            });
            
            // Selecionar o primeiro modelo por padr√£o se houver
            if (models.length > 0) {
                const firstModel = models[0].name || models[0];
                select.value = firstModel;
                console.log(`‚úÖ Modelo padr√£o selecionado: ${firstModel}`);
            }
        }

        function carregarModeloSalvo() {
            try {
                const savedModel = sessionStorage.getItem('current_model');
                if (savedModel) {
                    currentModel = JSON.parse(savedModel);
                    
                    // Atualizar UI com verifica√ß√µes de seguran√ßa
                    const currentModelTextEl = document.getElementById('currentModelText');
                    const currentModelDisplayEl = document.getElementById('currentModelDisplay');
                    const statusEl = document.getElementById('modelStatus');
                    
                    if (currentModelTextEl) {
                        currentModelTextEl.textContent = `${currentModel.provider.toUpperCase()} - ${currentModel.model}`;
                    }
                    if (currentModelDisplayEl) {
                        currentModelDisplayEl.textContent = `${currentModel.provider}/${currentModel.model}`;
                    }
                    if (statusEl) {
                        statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Ativo';
                        statusEl.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                    }
                    
                    console.log(`üîÑ Modelo carregado da sess√£o: ${currentModel.provider}/${currentModel.model}`);
                }
            } catch (error) {
                console.error('Erro ao carregar modelo salvo:', error);
            }
        }

        async function configurarTokenGitHub() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert('Por favor, insira o token GitHub');
                return;
            }
            
            try {
                // Configurar token via vari√°vel de ambiente (simulado)
                sessionStorage.setItem('github_token', token);
                alert('‚úÖ Token GitHub configurado para esta sess√£o');
                
            } catch (error) {
                console.error('Erro ao configurar token:', error);
                alert('Erro ao configurar token GitHub');
            }
        }

        // System Status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                updateSystemStatus(data.status);
                updateLangGraphStatus(data.langgraph_enabled);
                langGraphAvailable = data.langgraph_enabled;
                
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                updateSystemStatus('error');
            }
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            if (!statusElement) return;

            switch(status) {
                case 'healthy':
                    statusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Sistema Pronto';
                    statusElement.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium';
                    break;
                case 'degraded':
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Limitado';
                    statusElement.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium';
                    break;
                case 'error':
                    statusElement.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Erro';
                    statusElement.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium';
                    break;
            }
        }

        function updateLangGraphStatus(enabled) {
            const element = document.getElementById('langGraphStatus');
            if (!element) return;

            if (enabled) {
                element.innerHTML = '<i class="fas fa-project-diagram mr-1"></i>LangGraph Ativo';
                element.className = 'px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium';
            } else {
                element.innerHTML = '<i class="fas fa-project-diagram mr-1"></i>LangGraph Off';
                element.className = 'px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm font-medium';
            }
        }

        // Main Functions
        async function analisarDiretorio() {
            const projectPath = document.getElementById('projectPath').value.trim();
            const btnAnalisar = document.getElementById('btnAnalisar');
            
            if (!currentModel.provider) {
                alert('Por favor, selecione um modelo de IA primeiro (OpenAI ou Ollama)');
                return;
            }
            
            if (!projectPath) {
                alert('Por favor, informe o caminho do diret√≥rio do projeto');
                return;
            }

            console.log(`ü§ñ Iniciando an√°lise C4 do diret√≥rio: ${projectPath}`);

            // Preparar UI
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('analysisResults').classList.add('hidden');

            // Reset progress
            resetAllProgress();
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('phaseText').textContent = 'Iniciando An√°lise C4...';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('statusMessage').textContent = 'Preparando an√°lise do diret√≥rio local...';
            document.getElementById('logs').innerHTML = '';

            btnAnalisar.disabled = true;
            btnAnalisar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analisando...';

            try {
                // Preparar dados da requisi√ß√£o para diret√≥rio local
                const requestData = {
                    repo_url: `file://${projectPath}`, // Indicar que √© um diret√≥rio local
                    model_provider: currentModel.provider,
                    model_name: currentModel.model,
                    max_files: 50,
                    deep_analysis: true,
                    anonymous: document.getElementById('modoAnonimo')?.checked || true,
                    local_directory: projectPath
                };

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    // Iniciar polling de status
                    analysisInterval = setInterval(checkAnalysisStatus, 2000);
                    
                    document.getElementById('phaseText').textContent = 'An√°lise C4 iniciada';
                    document.getElementById('progressBar').style.width = '5%';
                    document.getElementById('progressText').textContent = '5%';
                    document.getElementById('statusMessage').textContent = 'Executando an√°lise arquitetural C4...';
                    
                    document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.message || 'Erro ao iniciar an√°lise');
                }
            } catch (error) {
                console.error('‚ùå Erro ao iniciar an√°lise:', error);
                
                document.getElementById('phaseText').textContent = 'Erro na an√°lise';
                document.getElementById('statusMessage').textContent = `Erro: ${error.message}`;
                document.getElementById('logs').innerHTML = `<div class="text-red-400">‚ùå ${error.message}</div>`;
            } finally {
                btnAnalisar.disabled = false;
                btnAnalisar.innerHTML = '<i class="fas fa-play mr-2"></i>An√°lise Completa (C4 + Detalhada)';
            }
        }

        function resetAllProgress() {
            // Reset C4 progress
            document.getElementById('contextStatus').textContent = 'Aguardando';
            document.getElementById('containerStatus').textContent = 'Aguardando';
            document.getElementById('componentStatus').textContent = 'Aguardando';
            document.getElementById('codeStatus').textContent = 'Aguardando';
            
            // Reset detailed analysis progress
            document.getElementById('detailedStatus').textContent = 'Aguardando';
            document.getElementById('structureStatus').textContent = 'Aguardando';
            document.getElementById('implementationStatus').textContent = 'Aguardando';
            document.getElementById('flowchartsStatus').textContent = 'Aguardando';
        }

        function updateAllProgress(phase, progress) {
            // Update based on progress percentage for 8 stages
            const stages = [
                { id: 'contextStatus', name: 'C4 Context', threshold: 12.5 },
                { id: 'containerStatus', name: 'C4 Container', threshold: 25 },
                { id: 'componentStatus', name: 'C4 Component', threshold: 37.5 },
                { id: 'codeStatus', name: 'C4 Code', threshold: 50 },
                { id: 'detailedStatus', name: 'Detailed Analysis', threshold: 62.5 },
                { id: 'structureStatus', name: 'Structure Report', threshold: 75 },
                { id: 'implementationStatus', name: 'Implementation', threshold: 87.5 },
                { id: 'flowchartsStatus', name: 'Flowcharts', threshold: 100 }
            ];
            
            stages.forEach(stage => {
                const element = document.getElementById(stage.id);
                if (progress >= stage.threshold) {
                    element.textContent = 'Conclu√≠do';
                } else if (progress >= (stage.threshold - 12.5)) {
                    element.textContent = 'Em andamento';
                } else {
                    element.textContent = 'Aguardando';
                }
            });
            
            // Special handling for specific phases
            switch(phase.toLowerCase()) {
                case 'local_ready':
                case 'cloned':
                case 'setup':
                    document.getElementById('contextStatus').textContent = 'Em andamento';
                    break;
                case 'analyzed':
                case 'structure':
                    document.getElementById('contextStatus').textContent = 'Conclu√≠do';
                    document.getElementById('containerStatus').textContent = 'Em andamento';
                    break;
                case 'planned':
                case 'planning':
                    document.getElementById('containerStatus').textContent = 'Conclu√≠do';
                    document.getElementById('componentStatus').textContent = 'Em andamento';
                    break;
                case 'generating':
                case 'documentation':
                    // Start detailed analysis phase
                    document.getElementById('codeStatus').textContent = 'Conclu√≠do';
                    document.getElementById('detailedStatus').textContent = 'Em andamento';
                    break;
                case 'completed':
                case 'conclu√≠do':
                    // All completed
                    stages.forEach(stage => {
                        document.getElementById(stage.id).textContent = 'Conclu√≠do';
                    });
                    break;
            }
        }



        async function checkAnalysisStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // Atualizar UI principal
                document.getElementById('phaseText').textContent = status.phase || 'Processando...';
                document.getElementById('progressText').textContent = (status.progress || 0) + '%';
                document.getElementById('progressBar').style.width = (status.progress || 0) + '%';
                document.getElementById('statusMessage').textContent = status.message || 'Processando...';
                
                // Atualizar progresso de todas as 8 etapas baseado na fase atual
                updateAllProgress(status.phase || '', status.progress || 0);
                
                // Atualizar logs
                if (status.logs && status.logs.length > 0) {
                    const logsHTML = status.logs.map(log => {
                        const timestamp = new Date().toLocaleTimeString();
                        const isError = log.includes('‚ùå');
                        const isSuccess = log.includes('‚úÖ');
                        const isC4 = log.includes('C4') || log.includes('Context') || log.includes('Container') || log.includes('Component');
                        
                        let logClass = 'text-green-300';
                        if (isError) logClass = 'text-red-400';
                        else if (isSuccess) logClass = 'text-green-400';
                        else if (isC4) logClass = 'text-blue-400';
                        
                        return `<div class="mb-1 ${logClass}">[${timestamp}] ${log}</div>`;
                    }).join('');
                    
                    document.getElementById('logs').innerHTML = logsHTML;
                    document.getElementById('logsContainer').scrollTop = document.getElementById('logsContainer').scrollHeight;
                }

                // Verificar status final
                if (status.status === 'completed') {
                    clearInterval(analysisInterval);
                    analysisInterval = null;
                    
                    // Finalizar todas as 8 etapas como conclu√≠do
                    updateAllProgress('completed', 100);
                    
                    setTimeout(() => {
                        loadAnalysisResults();
                    }, 1000);
                    
                } else if (status.status === 'error') {
                    clearInterval(analysisInterval);
                    analysisInterval = null;
                    
                    document.getElementById('phaseText').textContent = 'Erro na an√°lise';
                    document.getElementById('statusMessage').textContent = status.message || 'Erro desconhecido';
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
            }
        }

        async function loadAnalysisResults() {
            try {
                const response = await fetch('/api/results');
                const results = await response.json();

                const isLangGraph = results.langgraph_enabled !== false;
                
                document.getElementById('resultsContent').innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-sitemap text-green-600 text-2xl mr-3"></i>
                            <div>
                                <h4 class="font-bold text-green-800 text-lg">Skyone DocAgent - An√°lise Completa Conclu√≠da!</h4>
                                <p class="text-green-700">C4 + An√°lise Detalhada processada com sucesso</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-purple-50 rounded-lg p-6 border border-purple-200">
                            <h4 class="font-bold text-purple-800 mb-4">
                                <i class="fas fa-chart-bar mr-2"></i>
                                An√°lise Realizada
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Sistema:</span>
                                    <span class="font-medium">Skyone DocAgent</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Modelo:</span>
                                    <span class="font-medium">${results.model_used || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Documentos:</span>
                                    <span class="font-medium text-green-600">${results.generated_docs?.length || 0}/8 arquivos</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Tipos:</span>
                                    <span class="font-medium text-sm">C4 + An√°lise Detalhada</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-4">
                                <i class="fas fa-download mr-2"></i>
                                Downloads
                            </h4>
                            ${results.generated_docs && results.generated_docs.length > 0 ? `
                                <div class="mb-4 space-y-2">
                                    <a href="/api/download-all-zip" 
                                       class="flex items-center justify-center p-3 bg-gradient-to-r from-skyone to-skyoneLight text-white rounded-lg hover:from-skyoneLight hover:to-skyoneAccent transition-all">
                                        <i class="fas fa-file-archive mr-2"></i>
                                        Download ZIP Completo (${results.generated_docs?.length || 0} arquivos)
                                    </a>
                                    <a href="/api/generate-mermaid-chart" target="_blank"
                                       class="flex items-center justify-center p-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                                        <i class="fas fa-project-diagram mr-2"></i>
                                        Visualizar Workflow (Chart)
                                    </a>
                                </div>
                                <div class="space-y-2 max-h-40 overflow-y-auto">
                                    ${results.generated_docs
                                        .filter((filename, index, self) => 
                                            self.findIndex(f => f.replace('_anonimo', '') === filename.replace('_anonimo', '')) === index
                                        )
                                        .map(filename => {
                                            let icon = 'fas fa-file-alt';
                                            let color = 'text-blue-600';
                                            let category = 'Documento';
                                            
                                            if (filename.includes('C4_Context')) { 
                                                icon = 'fas fa-globe'; color = 'text-purple-600'; category = 'C4 Context';
                                            }
                                            else if (filename.includes('C4_Container')) { 
                                                icon = 'fas fa-cubes'; color = 'text-blue-600'; category = 'C4 Container';
                                            }
                                            else if (filename.includes('C4_Component')) { 
                                                icon = 'fas fa-puzzle-piece'; color = 'text-green-600'; category = 'C4 Component';
                                            }
                                            else if (filename.includes('C4_Code')) { 
                                                icon = 'fas fa-code'; color = 'text-indigo-600'; category = 'C4 Code';
                                            }
                                            else if (filename.includes('Detailed_Code')) { 
                                                icon = 'fas fa-search'; color = 'text-red-600'; category = 'An√°lise Detalhada';
                                            }
                                            else if (filename.includes('Structure_Report')) { 
                                                icon = 'fas fa-sitemap'; color = 'text-orange-600'; category = 'Relat√≥rio Estrutural';
                                            }
                                            else if (filename.includes('Implementation')) { 
                                                icon = 'fas fa-tools'; color = 'text-teal-600'; category = 'Guia Implementa√ß√£o';
                                            }
                                            else if (filename.includes('Flowcharts')) { 
                                                icon = 'fas fa-project-diagram'; color = 'text-pink-600'; category = 'Fluxogramas';
                                            }
                                            else if (filename.includes('workflow')) { 
                                                icon = 'fas fa-share-alt'; color = 'text-purple-600'; category = 'Workflow LangGraph';
                                            }
                                            
                                            return `
                                            <a href="/api/download/${filename}" 
                                               class="flex items-center justify-between p-3 bg-white rounded-lg border hover:border-skyone transition-colors">
                                                <div class="flex items-center">
                                                    <i class="${icon} ${color} mr-3 text-lg"></i>
                                                    <div>
                                                        <div class="font-medium text-gray-800">${category}</div>
                                                        <div class="text-xs text-gray-500">${filename.replace('_anonimo', ' (An√¥nimo)')}</div>
                                                    </div>
                                                </div>
                                                <i class="fas fa-download text-skyone"></i>
                                            </a>
                                            `;
                                        }).join('')}
                                </div>
                            ` : '<p class="text-blue-600">Nenhum documento gerado</p>'}
                        </div>
                    </div>
                `;

                document.getElementById('analysisResults').classList.remove('hidden');
                document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar resultados:', error);
                
                document.getElementById('resultsContent').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl mb-3"></i>
                        <h4 class="font-bold text-red-800 mb-2">Erro ao Carregar Resultados</h4>
                        <p class="text-red-700">${error.message}</p>
                    </div>
                `;
                
                document.getElementById('analysisResults').classList.remove('hidden');
            }
        }

        // Event listeners simplificados
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para Enter no campo de diret√≥rio
            document.getElementById('projectPath').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    analisarDiretorio();
                }
            });
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }
        });
    </script>
</body>
</html>
