<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyone DocAgent - Documentação Automática com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        skyone: '#1a365d',
                        skyoneLight: '#2d5a87',
                        skyoneAccent: '#4a90e2'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-skyone">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-skyone to-skyoneLight rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-skyone">Skyone DocAgent</h1>
                        <p class="text-sm text-skyoneLight font-medium">Documentação Automática com IA • Arquitetura C4</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="systemStatus" class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-sm font-medium">
                        <i class="fas fa-circle animate-pulse mr-1"></i>
                        Sistema
                    </span>
                    <span class="px-3 py-1 bg-skyone text-white rounded-full text-sm font-medium">
                        v3.0
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        
        <!-- Skyone Hero Section -->
        <div class="text-center mb-8">
            <div class="bg-gradient-to-r from-skyone to-skyoneLight rounded-2xl p-8 text-white shadow-xl">
                <h2 class="text-4xl font-bold mb-4">
                    <i class="fas fa-sitemap mr-3"></i>
                    Skyone DocAgent
                </h2>
                <p class="text-xl text-blue-100 max-w-3xl mx-auto">
                    Agente inteligente da Skyone para documentação automática com arquitetura C4.
                    Análise completa de projetos locais com IA avançada.
                </p>
            </div>
        </div>

        <!-- Model Selection Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-brain text-skyoneAccent text-xl mr-3"></i>
                <h3 class="text-xl font-bold text-skyone">Modelo de IA</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <!-- OpenAI -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-skyone mb-3">OpenAI GPT</h4>
                    <select id="openaiModel" class="w-full px-3 py-2 border rounded-lg mb-3">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                    <input type="password" id="openaiApiKey" placeholder="API Key..." 
                           class="w-full px-3 py-2 border rounded-lg mb-3">
                    <button onclick="selecionarOpenAI()" 
                            class="w-full bg-skyoneAccent text-white py-2 rounded-lg hover:bg-skyoneLight transition-all">
                        Usar OpenAI
                    </button>
                </div>

                <!-- Ollama -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-skyone mb-3">Ollama Local</h4>
                    <select id="ollamaModel" class="w-full px-3 py-2 border rounded-lg mb-3">
                        <option value="qwen2.5:7b">Qwen2.5 7B</option>
                        <option value="llama3.2:3b">Llama 3.2 3B</option>
                        <option value="codellama:7b">CodeLlama 7B</option>
                    </select>
                    <input type="text" id="ollamaBaseUrl" value="http://localhost:11434" 
                           class="w-full px-3 py-2 border rounded-lg mb-3">
                    <button onclick="selecionarOllama()" 
                            class="w-full bg-skyone text-white py-2 rounded-lg hover:bg-skyoneLight transition-all">
                        Usar Ollama
                    </button>
                </div>
            </div>
            
            <!-- Current Model -->
            <div class="bg-gray-50 rounded-lg p-3 flex items-center justify-between">
                <span class="text-sm text-gray-700">Modelo: <span id="currentModelText" class="font-semibold">Nenhum</span></span>
                <span id="currentModelDisplay" class="text-sm text-gray-700 font-mono bg-gray-200 px-2 py-1 rounded hidden">Nenhum</span>
                <span id="modelStatus" class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-sm">
                    <i class="fas fa-circle mr-1"></i>Aguardando
                </span>
            </div>
        </div>

        <!-- Directory Selection Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center mb-4">
                <i class="fas fa-folder text-skyoneAccent text-xl mr-3"></i>
                <h3 class="text-xl font-bold text-skyone">Diretório do Projeto</h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div class="lg:col-span-3">
                    <label for="projectPath" class="block text-sm font-medium text-gray-700 mb-2">
                        Caminho do Projeto Local
                    </label>
                    <input type="text" id="projectPath" placeholder="/caminho/para/seu/projeto" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-skyoneAccent">
                    <p class="text-xs text-gray-500 mt-1">Informe o caminho completo do diretório do projeto</p>
                </div>
                <div class="flex flex-col justify-end">
                    <label class="flex items-center mb-3">
                        <input type="checkbox" id="modoAnonimo" class="mr-2 h-4 w-4 text-skyoneAccent" checked>
                        <span class="text-sm text-gray-700">Relatório Anônimo</span>
                    </label>
                    <button onclick="analisarDiretorio()" id="btnAnalisar"
                            class="bg-gradient-to-r from-skyone to-skyoneLight text-white px-6 py-3 rounded-lg hover:from-skyoneLight hover:to-skyoneAccent transition-all font-medium">
                        <i class="fas fa-play mr-2"></i>
                        Iniciar Análise C4
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-600 text-lg font-medium">Buscando repositórios...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-folder-open text-blue-600 mr-3"></i>
                        Repositórios Encontrados
                    </h3>
                    <div class="flex space-x-4">
                        <select id="filtroLinguagem" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Todas as linguagens</option>
                        </select>
                        <select id="ordenacao" class="px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="stars">Mais estrelas</option>
                            <option value="name">Nome</option>
                            <option value="updated">Mais recente</option>
                        </select>
                    </div>
                </div>
                <div id="repositoriosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Repositórios serão inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div id="analysisSection" class="hidden">
            <!-- Skyone Analysis Section -->
            <div class="bg-gradient-to-r from-skyone to-skyoneLight rounded-2xl shadow-2xl p-8 mb-8 text-white">
                <h3 class="text-3xl font-bold mb-6 flex items-center">
                    <i class="fas fa-sitemap mr-4 text-4xl animate-pulse"></i>
                    <div>
                        <div>Skyone DocAgent</div>
                        <div class="text-lg font-normal text-blue-200">Arquitetura C4 • LangGraph</div>
                    </div>
                </h3>
                
                <!-- C4 Progress Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Context</div>
                        <div id="contextStatus" class="text-lg font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Container</div>
                        <div id="containerStatus" class="text-lg font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Component</div>
                        <div id="componentStatus" class="text-lg font-bold">Aguardando</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Code</div>
                        <div id="codeStatus" class="text-lg font-bold">Aguardando</div>
                    </div>
                </div>
                
                <!-- Main Status -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Fase Atual</div>
                        <div id="phaseText" class="text-xl font-bold">Iniciando...</div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur">
                        <div class="text-blue-200 text-sm font-medium">Progresso</div>
                        <div id="progressText" class="text-xl font-bold">0%</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="w-full bg-white bg-opacity-20 rounded-full h-4">
                        <div id="progressBar" class="bg-gradient-to-r from-skyoneAccent to-blue-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status Message -->
                <div id="statusMessage" class="text-lg text-blue-100 mb-4 p-3 bg-white bg-opacity-10 rounded-lg"></div>
                
                <!-- Logs Display -->
                <div class="bg-black bg-opacity-40 rounded-lg p-4 border border-white border-opacity-20">
                    <h4 class="font-bold text-lg mb-3 flex items-center">
                        <i class="fas fa-terminal mr-2 text-skyoneAccent"></i>
                        Logs do Skyone Agent
                        <span class="ml-auto text-sm text-gray-300">Tempo Real</span>
                    </h4>
                    <div id="logsContainer" class="max-h-64 overflow-y-auto">
                        <div id="logs" class="text-sm font-mono text-green-300 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="analysisResults" class="hidden bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-file-alt text-green-600 mr-3"></i>
                    Documentação LangGraph Concluída
                </h3>
                <div id="resultsContent">
                    <!-- Resultados serão inseridos aqui -->
                </div>
            </div>
        </div>



    </main>

    <!-- Footer -->
    <footer class="bg-skyone text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2024 <strong>Skyone DocAgent</strong> v3.0 - Documentação Automática com Arquitetura C4</p>
            <p class="text-blue-200 mt-2">Produto Skyone • IA Avançada • LangGraph</p>
        </div>
    </footer>

    <script>
        let repositorios = [];
        let analysisInterval = null;
        let currentModel = { provider: null, model: null };
        let langGraphAvailable = false;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🤖 Skyone DocAgent v3.0 carregado!');
            checkSystemStatus();
            carregarModeloSalvo();
            carregarModelosOllama();
            
            // Event listener para Enter no campo de diretório
            const projectPathEl = document.getElementById('projectPath');
            if (projectPathEl) {
                projectPathEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        analisarDiretorio();
                    }
                });
            }
        });

        // Model Management
        async function selecionarOpenAI() {
            const modelEl = document.getElementById('openaiModel');
            const apiKeyEl = document.getElementById('openaiApiKey');
            
            if (!modelEl || !apiKeyEl) {
                console.error('Elementos OpenAI não encontrados');
                return;
            }
            
            const model = modelEl.value;
            const apiKey = apiKeyEl.value.trim();
            
            if (!apiKey) {
                alert('Por favor, insira sua API Key do OpenAI');
                return;
            }
            
            // Testar e configurar OpenAI
            await testarEConfigurarModelo('openai', model, apiKey);
        }

        async function selecionarOllama() {
            const modelEl = document.getElementById('ollamaModel');
            const baseUrlEl = document.getElementById('ollamaBaseUrl');
            
            if (!modelEl || !baseUrlEl) {
                console.error('Elementos Ollama não encontrados');
                return;
            }
            
            const model = modelEl.value;
            const baseUrl = baseUrlEl.value.trim();
            
            // Testar e configurar Ollama
            await testarEConfigurarModelo('ollama', model, null, baseUrl);
        }

        async function testarEConfigurarModelo(provider, model, apiKey = null, baseUrl = null) {
            try {
                // Mostrar status de teste
                const statusEl = document.getElementById('modelStatus');
                if (!statusEl) {
                    console.error('Elemento modelStatus não encontrado');
                    return;
                }
                
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testando...';
                statusEl.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm';
                
                // Testar modelo primeiro
                const testResponse = await fetch('/api/test-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        model_name: model,
                        api_key: apiKey,
                        base_url: baseUrl
                    })
                });
                
                const testData = await testResponse.json();
                
                if (testData.success) {
                    // Teste bem-sucedido, configurar modelo
                    const configResponse = await fetch('/api/configure-model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            provider: provider,
                            model_name: model,
                            api_key: apiKey,
                            base_url: baseUrl
                        })
                    });
                    
                    const configData = await configResponse.json();
                    
                    if (configData.success) {
                        // Sucesso total
                        currentModel = { provider, model, apiKey, baseUrl };
                        
                        // Atualizar UI
                        const currentModelText = document.getElementById('currentModelText');
                        const currentModelDisplay = document.getElementById('currentModelDisplay');
                        
                        if (currentModelText) {
                            currentModelText.textContent = `${provider.toUpperCase()} - ${model}`;
                        }
                        
                        if (currentModelDisplay) {
                            currentModelDisplay.textContent = `${provider}/${model}`;
                            currentModelDisplay.classList.remove('hidden');
                        }
                        
                        statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Ativo';
                        statusEl.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                        
                        // Armazenar configuração
                        sessionStorage.setItem('current_model', JSON.stringify(currentModel));
                        
                        alert(`✅ Modelo ${provider.toUpperCase()}/${model} configurado com sucesso!`);
                        console.log(`✅ Modelo configurado: ${provider}/${model}`);
                    } else {
                        throw new Error(configData.message || 'Falha na configuração');
                    }
                } else {
                    throw new Error(testData.error || 'Falha no teste do modelo');
                }
                
            } catch (error) {
                console.error('Erro ao configurar modelo:', error);
                
                const statusEl = document.getElementById('modelStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Erro';
                    statusEl.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm';
                }
                
                alert(`❌ Erro ao configurar modelo: ${error.message}`);
            }
        }

        async function verificarOllama() {
            try {
                const baseUrlEl = document.getElementById('ollamaBaseUrl');
                if (!baseUrlEl) {
                    console.warn('Elemento ollamaBaseUrl não encontrado');
                    return;
                }
                
                const baseUrl = baseUrlEl.value.trim();
                
                // Tentar conectar com Ollama
                const response = await fetch(`${baseUrl}/api/tags`);
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`✅ Ollama conectado! Modelos disponíveis: ${data.models?.length || 0}`);
                    
                    // Atualizar lista de modelos
                    atualizarModelosOllama(data.models || []);
                } else {
                    alert('❌ Ollama não está rodando. Execute: ollama serve');
                }
            } catch (error) {
                alert('❌ Erro ao conectar com Ollama. Verifique se está rodando.');
                console.error('Erro Ollama:', error);
            }
        }

        async function carregarModelosOllama() {
            try {
                const response = await fetch('/api/models/available');
                const data = await response.json();
                
                if (data.success && data.ollama_detailed) {
                    atualizarModelosOllama(data.ollama_detailed);
                    console.log(`✅ ${data.ollama_detailed.length} modelos Ollama carregados`);
                } else {
                    console.warn('⚠️ Nenhum modelo Ollama encontrado');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar modelos Ollama:', error);
            }
        }

        function atualizarModelosOllama(models) {
            const select = document.getElementById('ollamaModel');
            if (!select) {
                console.warn('Elemento ollamaModel não encontrado');
                return;
            }
            
            select.innerHTML = '';
            
            if (models.length === 0) {
                select.innerHTML = '<option value="">Nenhum modelo encontrado</option>';
                return;
            }
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.display_name || model.name;
                select.appendChild(option);
            });
            
            // Selecionar o primeiro modelo por padrão se houver
            if (models.length > 0) {
                select.value = models[0].name;
            }
        }

        function carregarModeloSalvo() {
            try {
                const savedModel = sessionStorage.getItem('current_model');
                if (savedModel) {
                    currentModel = JSON.parse(savedModel);
                    
                    // Atualizar UI
                    const currentModelText = document.getElementById('currentModelText');
                    const currentModelDisplay = document.getElementById('currentModelDisplay');
                    
                    if (currentModelText) {
                        currentModelText.textContent = `${currentModel.provider.toUpperCase()} - ${currentModel.model}`;
                    }
                    
                    if (currentModelDisplay) {
                        currentModelDisplay.textContent = `${currentModel.provider}/${currentModel.model}`;
                        currentModelDisplay.classList.remove('hidden');
                    }
                    
                    const statusEl = document.getElementById('modelStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Ativo';
                        statusEl.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                    }
                    
                    console.log(`🔄 Modelo carregado da sessão: ${currentModel.provider}/${currentModel.model}`);
                }
            } catch (error) {
                console.error('Erro ao carregar modelo salvo:', error);
            }
        }

        async function configurarTokenGitHub() {
            const tokenEl = document.getElementById('githubToken');
            if (!tokenEl) {
                console.error('Elemento githubToken não encontrado');
                return;
            }
            
            const token = tokenEl.value.trim();
            if (!token) {
                alert('Por favor, insira o token GitHub');
                return;
            }
            
            try {
                // Configurar token via variável de ambiente (simulado)
                sessionStorage.setItem('github_token', token);
                alert('✅ Token GitHub configurado para esta sessão');
                
            } catch (error) {
                console.error('Erro ao configurar token:', error);
                alert('Erro ao configurar token GitHub');
            }
        }

        // System Status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                updateSystemStatus(data.status);
                updateLangGraphStatus(data.langgraph_enabled);
                langGraphAvailable = data.langgraph_enabled;
                
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                updateSystemStatus('error');
            }
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            if (!statusElement) {
                console.warn('Elemento systemStatus não encontrado');
                return;
            }

            switch(status) {
                case 'healthy':
                    statusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Sistema Pronto';
                    statusElement.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium';
                    break;
                case 'degraded':
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Limitado';
                    statusElement.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium';
                    break;
                case 'error':
                    statusElement.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Erro';
                    statusElement.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium';
                    break;
            }
        }

        function updateLangGraphStatus(enabled) {
            const element = document.getElementById('langGraphStatus');
            if (!element) {
                console.warn('Elemento langGraphStatus não encontrado');
                return;
            }

            if (enabled) {
                element.innerHTML = '<i class="fas fa-project-diagram mr-1"></i>LangGraph Ativo';
                element.className = 'px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium';
            } else {
                element.innerHTML = '<i class="fas fa-project-diagram mr-1"></i>LangGraph Off';
                element.className = 'px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm font-medium';
            }
        }

        // Main Functions
        async function analisarDiretorio() {
            const projectPathEl = document.getElementById('projectPath');
            const btnAnalisar = document.getElementById('btnAnalisar');
            
            if (!projectPathEl || !btnAnalisar) {
                console.error('Elementos necessários não encontrados');
                return;
            }
            
            const projectPath = projectPathEl.value.trim();
            
            if (!currentModel.provider) {
                alert('Por favor, selecione um modelo de IA primeiro (OpenAI ou Ollama)');
                return;
            }
            
            if (!projectPath) {
                alert('Por favor, informe o caminho do diretório do projeto');
                return;
            }

            console.log(`🤖 Iniciando análise C4 do diretório: ${projectPath}`);

            // Preparar UI
            const analysisSection = document.getElementById('analysisSection');
            const analysisResults = document.getElementById('analysisResults');
            const progressBar = document.getElementById('progressBar');
            const phaseText = document.getElementById('phaseText');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');
            const logs = document.getElementById('logs');
            
            if (analysisSection) analysisSection.classList.remove('hidden');
            if (analysisResults) analysisResults.classList.add('hidden');

            // Reset progress
            resetC4Progress();
            if (progressBar) progressBar.style.width = '0%';
            if (phaseText) phaseText.textContent = 'Iniciando Análise C4...';
            if (progressText) progressText.textContent = '0%';
            if (statusMessage) statusMessage.textContent = 'Preparando análise do diretório local...';
            if (logs) logs.innerHTML = '';

            btnAnalisar.disabled = true;
            btnAnalisar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analisando...';

            try {
                // Preparar dados da requisição para diretório local
                const requestData = {
                    repo_url: `file://${projectPath}`, // Indicar que é um diretório local
                    model_provider: currentModel.provider,
                    model_name: currentModel.model,
                    max_files: 50,
                    deep_analysis: true,
                    anonymous: (() => {
                        const modoAnonimo = document.getElementById('modoAnonimo');
                        return modoAnonimo ? modoAnonimo.checked : true;
                    })(),
                    local_directory: projectPath
                };

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    // Iniciar polling de status
                    analysisInterval = setInterval(checkAnalysisStatus, 2000);
                    
                    if (phaseText) phaseText.textContent = 'Análise C4 iniciada';
                    if (progressBar) progressBar.style.width = '5%';
                    if (progressText) progressText.textContent = '5%';
                    if (statusMessage) statusMessage.textContent = 'Executando análise arquitetural C4...';
                    
                    if (analysisSection) analysisSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.message || 'Erro ao iniciar análise');
                }
            } catch (error) {
                console.error('❌ Erro ao iniciar análise:', error);
                
                if (phaseText) phaseText.textContent = 'Erro na análise';
                if (statusMessage) statusMessage.textContent = `Erro: ${error.message}`;
                if (logs) logs.innerHTML = `<div class="text-red-400">❌ ${error.message}</div>`;
            } finally {
                btnAnalisar.disabled = false;
                btnAnalisar.innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Análise C4';
            }
        }

        function resetC4Progress() {
            const contextStatus = document.getElementById('contextStatus');
            const containerStatus = document.getElementById('containerStatus');
            const componentStatus = document.getElementById('componentStatus');
            const codeStatus = document.getElementById('codeStatus');
            
            if (contextStatus) contextStatus.textContent = 'Aguardando';
            if (containerStatus) containerStatus.textContent = 'Aguardando';
            if (componentStatus) componentStatus.textContent = 'Aguardando';
            if (codeStatus) codeStatus.textContent = 'Aguardando';
        }

        function updateC4Progress(phase) {
            // Reset all to default
            resetC4Progress();
            
            // Update based on current phase
            const contextStatus = document.getElementById('contextStatus');
            const containerStatus = document.getElementById('containerStatus');
            const componentStatus = document.getElementById('componentStatus');
            const codeStatus = document.getElementById('codeStatus');
            
            switch(phase.toLowerCase()) {
                case 'cloned':
                case 'setup':
                    if (contextStatus) contextStatus.textContent = 'Em andamento';
                    break;
                case 'analyzed':
                case 'structure':
                    if (contextStatus) contextStatus.textContent = 'Concluído';
                    if (containerStatus) containerStatus.textContent = 'Em andamento';
                    break;
                case 'planned':
                case 'planning':
                    if (contextStatus) contextStatus.textContent = 'Concluído';
                    if (containerStatus) containerStatus.textContent = 'Concluído';
                    if (componentStatus) componentStatus.textContent = 'Em andamento';
                    break;
                case 'completed':
                case 'concluído':
                    if (contextStatus) contextStatus.textContent = 'Concluído';
                    if (containerStatus) containerStatus.textContent = 'Concluído';
                    if (componentStatus) componentStatus.textContent = 'Concluído';
                    if (codeStatus) codeStatus.textContent = 'Concluído';
                    break;
            }
        }

        async function analisarRepositorio(repoUrl) {
            if (!currentModel.provider) {
                alert('Por favor, selecione um modelo de IA primeiro (OpenAI ou Ollama)');
                return;
            }
            
            if (!repoUrl || !repoUrl.includes('github.com')) {
                alert('URL do repositório inválida');
                return;
            }

            console.log(`🤖 Iniciando análise LangGraph de: ${repoUrl}`);

            // Preparar UI
            const results = document.getElementById('results');
            const analysisSection = document.getElementById('analysisSection');
            const analysisResults = document.getElementById('analysisResults');
            const progressBar = document.getElementById('progressBar');
            const phaseText = document.getElementById('phaseText');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');
            const currentModelDisplay = document.getElementById('currentModelDisplay');
            const logs = document.getElementById('logs');
            
            if (results) results.classList.add('hidden');
            if (analysisSection) analysisSection.classList.remove('hidden');
            if (analysisResults) analysisResults.classList.add('hidden');

            // Reset progress
            if (progressBar) progressBar.style.width = '0%';
            if (phaseText) phaseText.textContent = 'Iniciando LangGraph...';
            if (progressText) progressText.textContent = '0%';
            if (statusMessage) statusMessage.textContent = 'Preparando fluxo de agentes...';
            
            if (currentModelDisplay) {
                currentModelDisplay.textContent = `${currentModel.provider}/${currentModel.model}`;
                currentModelDisplay.classList.remove('hidden');
            }
            
            if (logs) logs.innerHTML = '';

            try {
                // Preparar dados da requisição
                const requestData = {
                    repo_url: repoUrl,
                    model_provider: currentModel.provider,
                    model_name: currentModel.model,
                    max_files: 50,
                    deep_analysis: true,
                    anonymous: (() => {
                        const modoAnonimo = document.getElementById('modoAnonimo');
                        return modoAnonimo ? modoAnonimo.checked : true;
                    })()
                };
                
                // Adicionar API key se for OpenAI
                if (currentModel.provider === 'openai' && currentModel.apiKey) {
                    // A API key será enviada via header ou variável de ambiente
                    sessionStorage.setItem('temp_openai_key', currentModel.apiKey);
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    // Iniciar polling de status
                    analysisInterval = setInterval(checkAnalysisStatus, 2000);
                    
                    if (phaseText) phaseText.textContent = 'LangGraph Flow iniciado';
                    if (progressBar) progressBar.style.width = '5%';
                    if (progressText) progressText.textContent = '5%';
                    if (statusMessage) statusMessage.textContent = 'Executando fluxo de agentes...';
                    
                    if (analysisSection) analysisSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.message || 'Erro ao iniciar análise');
                }
            } catch (error) {
                console.error('❌ Erro ao iniciar análise:', error);
                
                if (phaseText) phaseText.textContent = 'Erro na análise';
                if (statusMessage) statusMessage.textContent = `Erro: ${error.message}`;
                if (logs) logs.innerHTML = `<div class="text-red-400">❌ ${error.message}</div>`;
            }
        }

        async function checkAnalysisStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // Atualizar UI principal
                const phaseText = document.getElementById('phaseText');
                const progressText = document.getElementById('progressText');
                const progressBar = document.getElementById('progressBar');
                const statusMessage = document.getElementById('statusMessage');
                
                if (phaseText) phaseText.textContent = status.phase || 'Processando...';
                if (progressText) progressText.textContent = (status.progress || 0) + '%';
                if (progressBar) progressBar.style.width = (status.progress || 0) + '%';
                if (statusMessage) statusMessage.textContent = status.message || 'Processando...';
                
                // Atualizar progresso C4 baseado na fase atual
                updateC4Progress(status.phase || '');
                
                // Atualizar logs
                if (status.logs && status.logs.length > 0) {
                    const logsEl = document.getElementById('logs');
                    const logsContainer = document.getElementById('logsContainer');
                    
                    if (logsEl) {
                        const logsHTML = status.logs.map(log => {
                            const timestamp = new Date().toLocaleTimeString();
                            const isError = log.includes('❌');
                            const isSuccess = log.includes('✅');
                            const isC4 = log.includes('C4') || log.includes('Context') || log.includes('Container') || log.includes('Component');
                            
                            let logClass = 'text-green-300';
                            if (isError) logClass = 'text-red-400';
                            else if (isSuccess) logClass = 'text-green-400';
                            else if (isC4) logClass = 'text-blue-400';
                            
                            return `<div class="mb-1 ${logClass}">[${timestamp}] ${log}</div>`;
                        }).join('');
                        
                        logsEl.innerHTML = logsHTML;
                        
                        if (logsContainer) {
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    }
                }

                // Verificar status final
                if (status.status === 'completed') {
                    clearInterval(analysisInterval);
                    analysisInterval = null;
                    
                    // Finalizar todos os C4 como concluído
                    updateC4Progress('completed');
                    
                    setTimeout(() => {
                        loadAnalysisResults();
                    }, 1000);
                    
                } else if (status.status === 'error') {
                    clearInterval(analysisInterval);
                    analysisInterval = null;
                    
                    const phaseText = document.getElementById('phaseText');
                    const statusMessage = document.getElementById('statusMessage');
                    
                    if (phaseText) phaseText.textContent = 'Erro na análise';
                    if (statusMessage) statusMessage.textContent = status.message || 'Erro desconhecido';
                }
                
            } catch (error) {
                console.error('❌ Erro ao verificar status:', error);
            }
        }

        async function loadAnalysisResults() {
            try {
                const response = await fetch('/api/results');
                const results = await response.json();

                const isLangGraph = results.langgraph_enabled !== false;
                const resultsContent = document.getElementById('resultsContent');
                
                if (!resultsContent) {
                    console.error('Elemento resultsContent não encontrado');
                    return;
                }
                
                resultsContent.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-${isLangGraph ? 'project-diagram' : 'check-circle'} text-green-600 text-2xl mr-3"></i>
                            <div>
                                <h4 class="font-bold text-green-800 text-lg">Análise ${isLangGraph ? 'LangGraph' : 'Tradicional'} Concluída!</h4>
                                <p class="text-green-700">Sistema ${isLangGraph ? 'LangGraph' : 'tradicional'} processou o repositório</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-purple-50 rounded-lg p-6 border border-purple-200">
                            <h4 class="font-bold text-purple-800 mb-4">
                                <i class="fas fa-chart-bar mr-2"></i>
                                Análise Realizada
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Sistema:</span>
                                    <span class="font-medium">${isLangGraph ? 'LangGraph' : 'Tradicional'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Modelo:</span>
                                    <span class="font-medium">${results.model_used || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-purple-700">Documentos:</span>
                                    <span class="font-medium">${results.generated_docs?.length || 0}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                            <h4 class="font-bold text-blue-800 mb-4">
                                <i class="fas fa-download mr-2"></i>
                                Downloads
                            </h4>
                            ${results.generated_docs && results.generated_docs.length > 0 ? `
                                <div class="mb-4">
                                    <a href="/api/download-all-zip" 
                                       class="flex items-center justify-center p-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700 transition-all">
                                        <i class="fas fa-file-archive mr-2"></i>
                                        Download ZIP Completo
                                    </a>
                                </div>
                                <div class="space-y-2 max-h-32 overflow-y-auto">
                                    ${results.generated_docs.map(filename => `
                                        <a href="/api/download/${filename}" 
                                           class="flex items-center justify-between p-2 bg-white rounded border hover:border-blue-400 transition-colors text-sm">
                                            <span>${filename}</span>
                                            <i class="fas fa-download text-blue-600"></i>
                                        </a>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-blue-600">Nenhum documento gerado</p>'}
                        </div>
                    </div>
                `;

                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults) {
                    analysisResults.classList.remove('hidden');
                    analysisResults.scrollIntoView({ behavior: 'smooth' });
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar resultados:', error);
                
                if (resultsContent) {
                    resultsContent.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-2xl mb-3"></i>
                            <h4 class="font-bold text-red-800 mb-2">Erro ao Carregar Resultados</h4>
                            <p class="text-red-700">${error.message}</p>
                        </div>
                    `;
                }
                
                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults) {
                    analysisResults.classList.remove('hidden');
                }
            }
        }

        // Funções removidas - não mais necessárias para busca local

        // Event listeners simplificados
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para Enter no campo de diretório
            const projectPathEl = document.getElementById('projectPath');
            if (projectPathEl) {
                projectPathEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        analisarDiretorio();
                    }
                });
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }
        });
    </script>
</body>
</html>
